name: Tiny 10 Smart Boot
on: workflow_dispatch

jobs:
  run-vm:
    runs-on: ubuntu-latest
    steps:
      - name: üõ°Ô∏è Check Tailscale Secret
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if [ -z "$TS_KEY" ]; then
            echo "‚ùå ERROR: TAILSCALE_AUTH_KEY is missing! Check your spelling."
            exit 1
          else
            echo "‚úÖ Tailscale Key found!"
          fi

      - name: Fix KVM Permissions
        run: |
          sudo chmod 666 /dev/kvm
          sudo adduser $USER kvm

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm qemu-system-x86 ovmf

      - name: Download Tiny 10
        run: |
          echo "Downloading... this will take about 4 minutes."
          # This is the verified direct download link for 23H1 x64
          curl -L -o tiny10.iso "https://archive.org/download/tiny-10_202301/tiny10%2023h1%20x64.iso"

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Boot VM
        run: |
          qemu-img create -f qcow2 tiny10_disk.qcow2 20G
          echo "Starting Windows... Use your iMICE in VNC!"
          # Added explicit drive commands to prevent "No bootable device" error
          sudo qemu-system-x86_64 \
            -m 4G \
            -smp 2 \
            -cpu host \
            -enable-kvm \
            -drive file=tiny10.iso,media=cdrom \
            -drive file=tiny10_disk.qcow2,if=virtio \
            -vnc :0 \
            -nographic
